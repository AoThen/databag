version: '3.8'

# Databag Docker Compose é…ç½®ç¤ºä¾‹
# è‡ªåŠ¨æ¸…ç†åŠŸèƒ½é»˜è®¤å…³é—­ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨

services:
  databag:
    image: databag/databag:latest
    container_name: databag
    hostname: databag
    ports:
      - "443:443"    # HTTPS ç«¯å£
      - "80:80"      # HTTP é‡å®šå‘ç«¯å£
    volumes:
      - databag_data:/var/lib/databag  # æ•°æ®ç›®å½•
      - databag_web:/opt/databag       # Webåº”ç”¨ç›®å½•
      - databag_logs:/var/log/databag  # æ—¥å¿—ç›®å½•
    environment:
      # ==================== æ•°æ®æ¸…ç†é…ç½® ====================
      
      # ğŸš¨ è‡ªåŠ¨æ¸…ç†å¼€å…³ï¼šé»˜è®¤ falseï¼Œå¿…é¡»æ˜¾å¼è®¾ç½®ä¸º true æ‰å¯ç”¨
      # æ¨èå€¼ï¼šfalse (æ¨èä½¿ç”¨ Web ç•Œé¢æ‰‹åŠ¨ç®¡ç†æ¸…ç†)
      DATABAG_CLEANUP_ENABLED: "false"
      
       # è‡ªåŠ¨æ¸…ç†é—´éš”ï¼ˆå°æ—¶ï¼‰ï¼šä»…å½“ DATABAG_CLEANUP_ENABLED=true æ—¶ç”Ÿæ•ˆ
       # æ¨èå€¼ï¼š168 (7å¤©ä¸€æ¬¡)
       # å¯ç”¨èŒƒå›´ï¼š1-8760
      DATABAG_CLEANUP_INTERVAL_HOURS: "168"
      
      # æ¶ˆæ¯ä¿ç•™å¤©æ•°ï¼šè¶…è¿‡æ­¤å¤©æ•°çš„è€æ¶ˆæ¯å°†è¢«æ¸…ç†
      # æ¨èå€¼ï¼š90 (3ä¸ªæœˆ)
      # å¯ç”¨èŒƒå›´ï¼š1-3650
      DATABAG_MESSAGE_RETENTION_DAYS: "90"
      
      # æ–‡ä»¶ä¿ç•™å¤©æ•°ï¼šè¶…è¿‡æ­¤å¤©æ•°çš„è€æ–‡ä»¶å°†è¢«æ¸…ç†
      # æ¨èå€¼ï¼š180 (6ä¸ªæœˆ)
      # å¯ç”¨èŒƒå›´ï¼š1-3650
      DATABAG_ASSET_RETENTION_DAYS: "180"
      
      # ==================== IPå°ç¦é…ç½® ====================
      
      # IPå°ç¦æœ€å¤§æ—¶é•¿ï¼ˆå°æ—¶ï¼‰ï¼šæ‰‹åŠ¨å°ç¦çš„æœ€å¤§é™åˆ¶
      # æ¨èå€¼ï¼š720 (30å¤©)
      # å¯ç”¨èŒƒå›´ï¼š1-720
      # æ³¨æ„ï¼š0 è¡¨ç¤ºæ°¸ä¹…å°ç¦
      DATABAG_IP_BLOCK_MAX_DURATION: "720"
      
      # IPå°ç¦é˜ˆå€¼ï¼šè§¦å‘è‡ªåŠ¨å°ç¦çš„å¤±è´¥æ¬¡æ•°
      # æ¨èå€¼ï¼š5
      # å¯ç”¨èŒƒå›´ï¼š1-100
      DATABAG_IP_BLOCK_THRESHOLD: "5"
      
      # IPå°ç¦åŸºç¡€æ—¶é•¿ï¼ˆå°æ—¶ï¼‰ï¼šè‡ªåŠ¨å°ç¦çš„èµ·å§‹æ—¶é•¿
      # æ¨èå€¼ï¼š1
      # å¯ç”¨èŒƒå›´ï¼š1-168
      DATABAG_IP_BLOCK_BASE_DURATION: "1"
      
      # IPå°ç¦æ¸…ç†å¼€å…³ï¼šæ˜¯å¦å¯ç”¨è¿‡æœŸIPå°ç¦çš„è‡ªåŠ¨æ¸…ç†
      # æ¨èå€¼ï¼štrue (è·Ÿéšä¸»æ¸…ç†å¼€å…³ï¼‰
      # æ³¨æ„ï¼šå½“ DATABAG_CLEANUP_ENABLED=false æ—¶æ­¤é…ç½®ä¹Ÿæ— æ•ˆ
      DATABAG_IP_BLOCK_CLEANUP_ENABLED: "true"
      
      # ==================== å¯é€‰é…ç½® ====================
      
      # æ—¥å¿—çº§åˆ«ï¼šdebug, info, warn, error
      # æ¨èå€¼ï¼šinfo (ç”Ÿäº§ç¯å¢ƒ)ï¼Œdebug (è°ƒè¯•æ—¶)
      DATABAG_LOG_LEVEL: "info"
      
      # æ—¶åŒºè®¾ç½®
      TZ: "Asia/Shanghai"
      
      # èŠ‚ç‚¹åç§°ï¼ˆå¯é€‰ï¼Œç”¨äºå¤šèŠ‚ç‚¹éƒ¨ç½²ï¼‰
      # DATABAG_NODE_NAME: "node1"
      
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "--no-check-certificate", "https://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    user: "1000:1000"  # ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œ
    networks:
      - databag_network
    labels:
      - "com.databag.version=${DATABAG_VERSION:-latest}"
      - "com.databag.cleanup=disabled"
      - "maintainer=admin@example.com"

# å‘½åç½‘ç»œ
networks:
  databag_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1

# æ•°æ®å·
volumes:
  databag_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /srv/databag/data  # ä¿®æ”¹ä¸ºæœ¬åœ°è·¯å¾„
  databag_web:
    driver: local
  databag_logs:
    driver: local

# è¯´æ˜ï¼š
# 1. æ•°æ®æ¸…ç†åŠŸèƒ½é»˜è®¤å…³é—­ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨
# 2. IPå°ç¦æœ€å¤§æ—¶é•¿å·²æ‰©å±•ä¸º30å¤©ï¼ˆ720å°æ—¶ï¼‰
# 3. è‡ªåŠ¨æ¸…ç†é—´éš”å·²è°ƒæ•´ä¸º7å¤©ï¼ˆ168å°æ—¶ï¼‰
# 4. ä½¿ç”¨å‰è¯·åˆ›å»º /srv/databag/data ç›®å½•å¹¶è®¾ç½®æƒé™
# 5. å¯åŠ¨ï¼šdocker-compose up -d
# 6. æŸ¥çœ‹æ—¥å¿—ï¼šdocker-compose logs -f
# 7. åœæ­¢ï¼šdocker-compose down
